<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AresBrain â€” Mis Flashcards</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:#0b0d11;
  --surface:#13161d;
  --surface2:#1b1f2a;
  --border:#252a38;
  --accent:#4f8ef7;
  --accent2:#7c5cfc;
  --green:#3ecf8e;
  --red:#f75f5f;
  --yellow:#f7c948;
  --text:#e8eaf0;
  --muted:#5a6080;
  --muted2:#3a3f55;
}

body.light{
  --bg:#f0f2f7;
  --surface:#ffffff;
  --surface2:#e8ecf4;
  --border:#d4d9e8;
  --accent:#3a7ae8;
  --accent2:#6b44f0;
  --green:#1fa86a;
  --red:#e03a3a;
  --yellow:#c49a00;
  --text:#1a1d2e;
  --muted:#7a82a0;
  --muted2:#b0b8d0;
}

body{
  background:var(--bg);
  color:var(--text);
  font-family:'DM Sans',system-ui,sans-serif;
  height:100vh;
  display:flex;
  overflow:hidden;
  background-image:
    radial-gradient(ellipse 600px 400px at 10% 0%,rgba(79,142,247,0.06) 0%,transparent 70%),
    radial-gradient(ellipse 500px 300px at 90% 100%,rgba(124,92,252,0.05) 0%,transparent 70%);
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar{
  width:240px;
  flex-shrink:0;
  background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  padding:0;
  overflow:hidden;
}

.logo{
  padding:22px 20px 18px;
  border-bottom:1px solid var(--border);
}
.logo-title{
  font-family:'Bebas Neue',sans-serif;
  font-size:1.7rem;
  letter-spacing:0.06em;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
  line-height:1;
}
.logo-sub{
  font-size:0.68rem;
  color:var(--muted);
  letter-spacing:0.12em;
  text-transform:uppercase;
  margin-top:3px;
}

.sidebar-nav{
  padding:12px 10px;
  flex:1;
  overflow-y:auto;
}

.nav-section-label{
  font-size:0.62rem;
  letter-spacing:0.18em;
  text-transform:uppercase;
  color:var(--muted2);
  padding:8px 8px 4px;
  margin-top:8px;
}

.nav-item{
  display:flex;
  align-items:center;
  gap:10px;
  padding:9px 10px;
  border-radius:8px;
  cursor:pointer;
  font-size:0.88rem;
  color:var(--muted);
  transition:all 0.15s;
  margin-bottom:2px;
  border:none;
  background:none;
  width:100%;
  text-align:left;
}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:rgba(79,142,247,0.12);color:var(--accent);}
.nav-item svg{width:16px;height:16px;flex-shrink:0;}

.deck-list{padding:8px 10px;flex:none;}
.deck-label{
  font-size:0.62rem;
  letter-spacing:0.18em;
  text-transform:uppercase;
  color:var(--muted2);
  padding:4px 8px 8px;
}
.deck-item{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
  font-size:0.85rem;
  color:var(--muted);
  transition:all 0.15s;
  margin-bottom:2px;
  border:none;
  background:none;
  width:100%;
  text-align:left;
}
.deck-item:hover{background:var(--surface2);color:var(--text);}
.deck-item.active{background:rgba(79,142,247,0.1);color:var(--text);}
.deck-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.deck-count{
  font-size:0.7rem;
  background:var(--surface2);
  color:var(--muted);
  padding:2px 7px;
  border-radius:20px;
  flex-shrink:0;
  margin-left:6px;
}
.deck-item.active .deck-count{background:rgba(79,142,247,0.2);color:var(--accent);}

.add-deck-btn{
  margin:0 10px 12px;
  padding:8px 10px;
  border:1px dashed var(--border);
  background:none;
  color:var(--muted);
  border-radius:8px;
  font-size:0.82rem;
  cursor:pointer;
  display:flex;align-items:center;gap:8px;
  transition:all 0.15s;
  font-family:'DM Sans',sans-serif;
}
.add-deck-btn:hover{border-color:var(--accent);color:var(--accent);}

/* â”€â”€ MAIN â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}

.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:16px 28px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
  gap:12px;
}
.topbar-title{
  font-family:'Bebas Neue',sans-serif;
  font-size:1.35rem;
  letter-spacing:0.06em;
  color:var(--text);
}
.topbar-actions{display:flex;gap:8px;align-items:center;}

.btn{
  padding:7px 16px;
  border-radius:7px;
  border:1px solid var(--border);
  background:var(--surface2);
  color:var(--text);
  font-family:'DM Sans',sans-serif;
  font-size:0.82rem;
  cursor:pointer;
  display:flex;align-items:center;gap:6px;
  transition:all 0.15s;
}
.btn:hover{border-color:var(--accent);color:var(--accent);}
.btn-primary{background:var(--accent);border-color:var(--accent);color:#fff;}
.btn-primary:hover{background:#3a7ae8;border-color:#3a7ae8;color:#fff;}
.btn-danger{background:rgba(247,95,95,0.1);border-color:rgba(247,95,95,0.3);color:var(--red);}
.btn-danger:hover{background:rgba(247,95,95,0.2);}
.btn svg{width:14px;height:14px;}

/* â”€â”€ VIEW: DASHBOARD â”€â”€ */
.view{flex:1;overflow-y:auto;padding:28px;}
.view.hidden{display:none;}

.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:32px;}
.stat-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
}
.stat-value{font-family:'Bebas Neue',sans-serif;font-size:2.4rem;letter-spacing:0.04em;line-height:1;}
.stat-label{font-size:0.76rem;color:var(--muted);margin-top:4px;letter-spacing:0.06em;text-transform:uppercase;}
.stat-card.accent .stat-value{color:var(--accent);}
.stat-card.green .stat-value{color:var(--green);}
.stat-card.yellow .stat-value{color:var(--yellow);}
.stat-card.purple .stat-value{color:var(--accent2);}

.section-title{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:0.08em;color:var(--muted);margin-bottom:14px;margin-top:8px;}

.deck-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;}
.deck-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  cursor:pointer;
  transition:all 0.2s;
  position:relative;
  overflow:hidden;
}
.deck-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  opacity:0;transition:opacity 0.2s;
}
.deck-card:hover{border-color:rgba(79,142,247,0.3);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.deck-card:hover::before{opacity:1;}
.deck-card-title{font-size:1rem;font-weight:500;margin-bottom:6px;}
.deck-card-meta{font-size:0.78rem;color:var(--muted);}
.deck-card-actions{display:flex;gap:6px;margin-top:14px;}
.deck-card .btn{padding:5px 10px;font-size:0.75rem;}

/* â”€â”€ VIEW: STUDY â”€â”€ */
.study-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
.study-deck-name{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:0.06em;}
.study-progress-wrap{flex:1;max-width:300px;height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;}
.study-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:2px;transition:width 0.4s ease;}
.study-stats{display:flex;gap:16px;font-size:0.8rem;color:var(--muted);}
.study-stats .g{color:var(--green);}
.study-stats .r{color:var(--red);}

.scene{
  width:100%;max-width:680px;margin:0 auto;
  height:320px;
  perspective:1200px;
  cursor:pointer;
}
.card-3d{
  width:100%;height:100%;
  position:relative;
  transform-style:preserve-3d;
  transition:transform 0.6s cubic-bezier(0.4,0.2,0.2,1);
}
.card-3d.flipped{transform:rotateY(180deg);}
.face{
  position:absolute;inset:0;
  backface-visibility:hidden;
  border-radius:16px;
  border:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:3rem 2.5rem;
  text-align:center;
}
.face-front{
  background:var(--surface);
  box-shadow:0 12px 48px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.04);
}
.face-back{
  background:var(--surface2);
  transform:rotateY(180deg);
  border-color:rgba(62,207,142,0.2);
  box-shadow:0 12px 48px rgba(0,0,0,0.5),inset 0 1px 0 rgba(62,207,142,0.05);
}
.face-label{
  font-size:0.6rem;letter-spacing:0.25em;text-transform:uppercase;
  margin-bottom:16px;
}
.face-front .face-label{color:var(--accent);}
.face-back .face-label{color:var(--green);}
.face-text{font-size:clamp(0.95rem,2vw,1.15rem);line-height:1.65;font-weight:300;}
.face-hint{margin-top:20px;font-size:0.7rem;color:var(--muted);font-style:italic;}

.study-actions{
  display:flex;justify-content:center;gap:14px;margin-top:20px;
  opacity:0;transform:translateY(10px);
  transition:opacity 0.3s,transform 0.3s;
  pointer-events:none;
}
.study-actions.show{opacity:1;transform:translateY(0);pointer-events:all;}
.btn-know{background:rgba(62,207,142,0.1);border:1px solid rgba(62,207,142,0.3);color:var(--green);padding:10px 28px;border-radius:8px;font-size:0.9rem;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.15s;}
.btn-know:hover{background:rgba(62,207,142,0.2);}
.btn-dontknow{background:rgba(247,95,95,0.1);border:1px solid rgba(247,95,95,0.3);color:var(--red);padding:10px 28px;border-radius:8px;font-size:0.9rem;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all 0.15s;}
.btn-dontknow:hover{background:rgba(247,95,95,0.2);}

.study-nav{display:flex;align-items:center;justify-content:center;gap:16px;margin-top:16px;}
.nav-circle{width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:none;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.15s;font-size:1rem;}
.nav-circle:hover{border-color:var(--accent);color:var(--accent);}
.card-counter{font-size:0.8rem;color:var(--muted);min-width:70px;text-align:center;}

.study-finish{text-align:center;padding:3rem 1rem;}
.finish-score{font-family:'Bebas Neue',sans-serif;font-size:5rem;letter-spacing:0.04em;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.finish-title{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;color:var(--text);margin-bottom:8px;}
.finish-msg{color:var(--muted);font-size:0.9rem;max-width:380px;margin:0 auto 24px;line-height:1.6;}
.finish-actions{display:flex;gap:10px;justify-content:center;}

/* â”€â”€ VIEW: EDITOR â”€â”€ */
.editor-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:20px;flex-wrap:wrap;}
.editor-table{width:100%;border-collapse:collapse;}
.editor-table th{
  text-align:left;padding:10px 14px;font-size:0.7rem;letter-spacing:0.15em;text-transform:uppercase;
  color:var(--muted);border-bottom:1px solid var(--border);font-weight:400;
}
.editor-table td{
  padding:6px 8px;border-bottom:1px solid rgba(37,42,56,0.5);vertical-align:middle;
}
.editor-table tr:hover td{background:rgba(255,255,255,0.015);}
.cell-input{
  background:transparent;border:1px solid transparent;color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:0.88rem;padding:6px 8px;
  border-radius:5px;width:100%;outline:none;transition:border-color 0.15s;
  resize:none;
}
.cell-input:focus{border-color:var(--accent);background:rgba(79,142,247,0.05);}
.row-num{color:var(--muted2);font-size:0.78rem;text-align:center;width:36px;}
.del-row{
  background:none;border:none;color:var(--muted2);cursor:pointer;
  padding:4px 6px;border-radius:4px;transition:all 0.15s;font-size:1rem;
}
.del-row:hover{color:var(--red);background:rgba(247,95,95,0.1);}

/* â”€â”€ MODAL â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.7);
  backdrop-filter:blur(4px);
  display:flex;align-items:center;justify-content:center;
  z-index:100;opacity:0;pointer-events:none;transition:opacity 0.2s;
}
.overlay.show{opacity:1;pointer-events:all;}
.modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:14px;padding:28px;width:90%;max-width:460px;
  transform:translateY(12px);transition:transform 0.25s;
  box-shadow:0 24px 64px rgba(0,0,0,0.6);
}
.overlay.show .modal{transform:translateY(0);}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:0.06em;margin-bottom:18px;}
.modal-field{margin-bottom:14px;}
.modal-label{font-size:0.72rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;display:block;}
.modal-input{
  width:100%;background:var(--surface2);border:1px solid var(--border);
  color:var(--text);font-family:'DM Sans',sans-serif;font-size:0.9rem;
  padding:9px 12px;border-radius:7px;outline:none;transition:border-color 0.15s;
}
.modal-input:focus{border-color:var(--accent);}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;}

/* â”€â”€ IMPORT DROP â”€â”€ */
.drop-zone{
  border:2px dashed var(--border);border-radius:12px;padding:3rem 2rem;
  text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:20px;
  background:var(--surface);
}
.drop-zone:hover,.drop-zone.drag{border-color:var(--accent);background:rgba(79,142,247,0.04);}
.drop-icon{font-size:2.5rem;margin-bottom:10px;}
.drop-text{color:var(--muted);font-size:0.88rem;line-height:1.6;}
.drop-text strong{color:var(--accent);}

/* â”€â”€ TESTS VIEW â”€â”€ */
.test-drop-zone{
  border:2px dashed var(--border);border-radius:12px;padding:2.5rem 2rem;
  text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:20px;
  background:var(--surface);
}
.test-drop-zone:hover,.test-drop-zone.drag{border-color:var(--accent2);background:rgba(124,92,252,0.03);}

.saved-tests-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px;margin-bottom:24px;}
.saved-test-card{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:18px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;
}
.saved-test-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--accent2),#c084fc);opacity:0;transition:opacity 0.2s;
}
.saved-test-card:hover{border-color:rgba(124,92,252,0.3);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.saved-test-card:hover::before{opacity:1;}
.saved-test-icon{font-size:1.8rem;margin-bottom:8px;}
.saved-test-name{font-size:0.92rem;font-weight:500;margin-bottom:4px;}
.saved-test-meta{font-size:0.75rem;color:var(--muted);}
.saved-test-actions{display:flex;gap:6px;margin-top:12px;}
.saved-test-actions .btn{padding:5px 10px;font-size:0.74rem;}

/* Test taking UI */
.test-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;}
.test-title-bar{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:0.06em;}
.test-progress-wrap{flex:1;max-width:280px;height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;}
.test-progress-bar{height:100%;background:linear-gradient(90deg,var(--accent2),#c084fc);border-radius:2px;transition:width 0.4s ease;}
.test-counter{font-size:0.8rem;color:var(--muted);}

.question-card{
  background:var(--surface);border:1px solid var(--border);border-radius:14px;
  padding:28px;max-width:720px;margin:0 auto;
}
.question-num{font-size:0.65rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--accent2);margin-bottom:10px;}
.question-type-badge{
  display:inline-block;font-size:0.6rem;letter-spacing:0.12em;text-transform:uppercase;
  padding:2px 8px;border-radius:20px;margin-left:8px;
  background:rgba(124,92,252,0.12);color:var(--accent2);
}
.question-text{font-size:1.05rem;line-height:1.6;margin-bottom:22px;font-weight:400;}

.options-list{display:flex;flex-direction:column;gap:10px;}
.option-btn{
  display:flex;align-items:flex-start;gap:12px;
  padding:12px 16px;border-radius:10px;
  border:1px solid var(--border);background:var(--surface2);
  color:var(--text);cursor:pointer;text-align:left;width:100%;
  font-family:'DM Sans',sans-serif;font-size:0.9rem;line-height:1.5;
  transition:all 0.15s;
}
.option-btn:hover:not(:disabled){border-color:var(--accent2);background:rgba(124,92,252,0.06);}
.option-letter{
  width:26px;height:26px;border-radius:50%;
  background:var(--border);color:var(--muted);
  display:flex;align-items:center;justify-content:center;
  font-size:0.75rem;font-weight:500;flex-shrink:0;
  transition:all 0.15s;
}
.option-btn:hover:not(:disabled) .option-letter{background:var(--accent2);color:#fff;}
.option-btn.correct{border-color:var(--green);background:rgba(62,207,142,0.08);}
.option-btn.correct .option-letter{background:var(--green);color:#fff;}
.option-btn.wrong{border-color:var(--red);background:rgba(247,95,95,0.08);}
.option-btn.wrong .option-letter{background:var(--red);color:#fff;}
.option-btn.missed{border-color:var(--green);background:rgba(62,207,142,0.04);opacity:0.7;}
.option-btn.missed .option-letter{border:2px solid var(--green);background:transparent;color:var(--green);}
.option-btn:disabled{cursor:default;}

.feedback-box{
  margin-top:16px;padding:14px 16px;border-radius:10px;
  font-size:0.88rem;line-height:1.6;
  opacity:0;transform:translateY(6px);
  transition:all 0.3s;
}
.feedback-box.show{opacity:1;transform:translateY(0);}
.feedback-box.ok{background:rgba(62,207,142,0.08);border:1px solid rgba(62,207,142,0.25);color:var(--green);}
.feedback-box.ko{background:rgba(247,95,95,0.08);border:1px solid rgba(247,95,95,0.25);color:var(--red);}
.feedback-why{color:var(--text);margin-top:6px;font-size:0.85rem;line-height:1.6;}

.next-btn-wrap{margin-top:18px;display:flex;justify-content:flex-end;
  opacity:0;transform:translateY(6px);transition:all 0.3s;pointer-events:none;}
.next-btn-wrap.show{opacity:1;transform:translateY(0);pointer-events:all;}

/* Test results */
.test-results{max-width:680px;margin:0 auto;}
.result-score-big{
  font-family:'Bebas Neue',sans-serif;font-size:5rem;letter-spacing:0.04em;
  background:linear-gradient(135deg,var(--accent2),#c084fc);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  line-height:1;
}
.result-header{text-align:center;padding:2rem 1rem 1.5rem;}
.result-subtitle{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;color:var(--text);margin-bottom:6px;}
.result-msg{color:var(--muted);font-size:0.9rem;max-width:380px;margin:0 auto;}
.result-stats{display:flex;justify-content:center;gap:24px;margin:16px 0 24px;flex-wrap:wrap;}
.result-stat{text-align:center;}
.result-stat-val{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:0.04em;}
.result-stat-lbl{font-size:0.7rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);}
.result-stat.g .result-stat-val{color:var(--green);}
.result-stat.r .result-stat-val{color:var(--red);}

.result-review{margin-top:8px;}
.result-review-item{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:18px;margin-bottom:10px;
}
.result-review-item.ok{border-left:3px solid var(--green);}
.result-review-item.ko{border-left:3px solid var(--red);}
.result-q{font-size:0.9rem;font-weight:500;margin-bottom:8px;}
.result-your{font-size:0.82rem;color:var(--red);margin-bottom:4px;}
.result-correct{font-size:0.82rem;color:var(--green);margin-bottom:6px;}
.result-explanation{font-size:0.82rem;color:var(--muted);line-height:1.5;padding:8px 10px;background:var(--surface2);border-radius:6px;}

/* scrollbar */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted2);}

/* toast */
.toast{
  position:fixed;bottom:28px;right:28px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text);padding:12px 20px;border-radius:10px;
  font-size:0.85rem;z-index:200;
  opacity:0;transform:translateY(8px);
  transition:all 0.3s;pointer-events:none;
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
}
.toast.show{opacity:1;transform:translateY(0);}
.toast.ok{border-color:rgba(62,207,142,0.4);color:var(--green);}
.toast.err{border-color:rgba(247,95,95,0.4);color:var(--red);}

input[type=file]{display:none;}

.theme-btn{
  width:36px;height:36px;border-radius:50%;
  border:1px solid var(--border);
  background:var(--surface2);
  color:var(--muted);
  cursor:pointer;font-size:1rem;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.2s;flex-shrink:0;
}
.theme-btn:hover{border-color:var(--accent);color:var(--accent);}

body.light .face-front{box-shadow:0 12px 48px rgba(0,0,0,0.12),inset 0 1px 0 rgba(255,255,255,0.8);}
body.light .face-back{box-shadow:0 12px 48px rgba(0,0,0,0.1);}
body.light .deck-card:hover{box-shadow:0 8px 24px rgba(0,0,0,0.1);}
body.light .modal{box-shadow:0 24px 64px rgba(0,0,0,0.15);}

/* â”€â”€ PDFs VIEW â”€â”€ */
.pdf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;margin-bottom:28px;}
.pdf-card{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:18px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;
}
.pdf-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,#f75f5f,#f7c948);opacity:0;transition:opacity 0.2s;
}
.pdf-card:hover{border-color:rgba(247,95,95,0.3);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.pdf-card:hover::before{opacity:1;}
.pdf-icon{font-size:2rem;margin-bottom:10px;}
.pdf-name{font-size:0.9rem;font-weight:500;margin-bottom:4px;word-break:break-word;}
.pdf-meta{font-size:0.75rem;color:var(--muted);}
.pdf-card-actions{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap;}
.pdf-card .btn{padding:5px 10px;font-size:0.74rem;}
.pdf-card .btn-pdf-delete{background:rgba(247,95,95,0.08);border-color:rgba(247,95,95,0.2);color:var(--red);}

/* PDF Viewer modal */
.pdf-viewer-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.85);
  backdrop-filter:blur(6px);z-index:150;
  display:flex;flex-direction:column;
  opacity:0;pointer-events:none;transition:opacity 0.2s;
}
.pdf-viewer-overlay.show{opacity:1;pointer-events:all;}
.pdf-viewer-bar{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border);
  flex-shrink:0;gap:12px;
}
.pdf-viewer-title{font-size:0.9rem;font-weight:500;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pdf-viewer-body{flex:1;overflow:hidden;display:flex;}
.pdf-viewer-body iframe{width:100%;height:100%;border:none;}

/* AI generation panel */
.ai-panel{
  background:var(--surface);border:1px solid var(--border);border-radius:12px;
  padding:20px;margin-bottom:24px;
}
.ai-panel-title{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:0.08em;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.ai-badge{font-size:0.62rem;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;padding:2px 8px;border-radius:20px;letter-spacing:0.1em;text-transform:uppercase;font-family:'DM Sans',sans-serif;}
.ai-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.ai-count-input{
  background:var(--surface2);border:1px solid var(--border);color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:0.88rem;padding:7px 12px;
  border-radius:7px;outline:none;width:90px;transition:border-color 0.15s;
}
.ai-count-input:focus{border-color:var(--accent);}
.ai-status{font-size:0.82rem;color:var(--muted);display:flex;align-items:center;gap:8px;}
.spinner{
  width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin 0.7s linear infinite;display:inline-block;
}
@keyframes spin{to{transform:rotate(360deg);}}

.ai-preview-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin-top:16px;}
.ai-preview-card{
  background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;
}
.ai-preview-q{font-size:0.82rem;color:var(--text);margin-bottom:6px;font-weight:500;}
.ai-preview-a{font-size:0.8rem;color:var(--muted);line-height:1.5;}

.drop-zone-pdf{
  border:2px dashed var(--border);border-radius:12px;padding:2.5rem 2rem;
  text-align:center;cursor:pointer;transition:all 0.2s;margin-bottom:20px;
  background:var(--surface);
}
.drop-zone-pdf:hover,.drop-zone-pdf.drag{border-color:#f75f5f;background:rgba(247,95,95,0.03);}

</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="logo">
    <div class="logo-title">AresBrain</div>
    <div class="logo-sub">GestiÃ³n de tarjetas</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">General</div>
    <button class="nav-item active" onclick="showView('dashboard')" id="nav-dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Inicio
    </button>
    <button class="nav-item" onclick="showView('import')" id="nav-import">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Importar CSV
    </button>
    <button class="nav-item" onclick="showView('pdfs')" id="nav-pdfs">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Mis PDFs
    </button>
    <button class="nav-item" onclick="showView('tests')" id="nav-tests">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/></svg>
      Tests
    </button>
  </nav>
  <div id="lastPdfSection" style="display:none;padding:8px 10px 0;">
    <div class="deck-label">Ãšltimo PDF</div>
    <button class="deck-item" id="lastPdfItem" onclick="openLastPdf()">
      <span style="font-size:0.95rem;margin-right:6px;">ğŸ“„</span>
      <span class="deck-name" id="lastPdfName">â€”</span>
    </button>
  </div>
  <div class="deck-list" id="deckList">
    <div class="deck-label">Mis mazos</div>
    <!-- injected -->
  </div>
  <button class="add-deck-btn" onclick="openNewDeck()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    Nuevo mazo
  </button>
</aside>

<!-- MAIN -->
<main class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-title" id="topbarTitle">Inicio</div>
    <div class="topbar-actions" id="topbarActions"></div>
  <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="Cambiar tema">ğŸŒ™</button>
  </div>

  <!-- VIEW: DASHBOARD -->
  <div class="view" id="view-dashboard">
    <div class="dashboard-grid">
      <div class="stat-card accent"><div class="stat-value" id="statDecks">0</div><div class="stat-label">Mazos</div></div>
      <div class="stat-card green"><div class="stat-value" id="statCards">0</div><div class="stat-label">Tarjetas totales</div></div>
      <div class="stat-card yellow"><div class="stat-value" id="statStudied">0</div><div class="stat-label">Sesiones</div></div>
      <div class="stat-card purple"><div class="stat-value" id="statScore">â€”</div><div class="stat-label">Ãšltimo resultado</div></div>
    </div>
    <div class="section-title">Todos los mazos</div>
    <div class="deck-cards" id="deckCardsGrid"></div>
    <div id="emptyState" style="text-align:center;padding:4rem;color:var(--muted);display:none;">
      <div style="font-size:3rem;margin-bottom:12px;">ğŸ“š</div>
      <div style="font-size:1rem;margin-bottom:8px;">No tienes mazos todavÃ­a</div>
      <div style="font-size:0.85rem;">Crea uno nuevo o importa un CSV</div>
    </div>
  </div>

  <!-- VIEW: STUDY -->
  <div class="view hidden" id="view-study">
    <div class="study-header">
      <div class="study-deck-name" id="studyDeckName">Mazo</div>
      <div class="study-progress-wrap"><div class="study-progress-bar" id="studyProgress" style="width:0%"></div></div>
      <div class="study-stats">
        <span class="g">âœ“ <span id="studyGood">0</span></span>
        <span class="r">âœ— <span id="studyBad">0</span></span>
      </div>
    </div>

    <div id="studyCardArea">
      <div class="scene" id="scene" onclick="flipCard()">
        <div class="card-3d" id="card3d">
          <div class="face face-front">
            <div class="face-label">Pregunta</div>
            <div class="face-text" id="faceQ"></div>
            <div class="face-hint">Clic para ver la respuesta Â· Espacio</div>
          </div>
          <div class="face face-back">
            <div class="face-label">Respuesta</div>
            <div class="face-text" id="faceA"></div>
          </div>
        </div>
      </div>
      <div class="study-actions" id="studyActions">
        <button class="btn-dontknow" onclick="rateCard(false)">âœ— No lo sabÃ­a</button>
        <button class="btn-know" onclick="rateCard(true)">âœ“ Lo sabÃ­a</button>
      </div>
      <div class="study-nav">
        <button class="nav-circle" onclick="prevCard()">â†</button>
        <div class="card-counter" id="studyCounter">1 / 1</div>
        <button class="nav-circle" onclick="nextCardNav()">â†’</button>
      </div>
    </div>

    <div class="study-finish hidden" id="studyFinish">
      <div class="finish-score" id="finishScore">0%</div>
      <div class="finish-title">SesiÃ³n completada</div>
      <div class="finish-msg" id="finishMsg"></div>
      <div class="finish-actions">
        <button class="btn" onclick="shuffleAndRestart()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/></svg>
          Repetir barajado
        </button>
        <button class="btn btn-primary" onclick="showView('dashboard')">Volver al inicio</button>
      </div>
    </div>
  </div>

  <!-- VIEW: EDITOR -->
  <div class="view hidden" id="view-editor">
    <div class="editor-toolbar">
      <button class="btn btn-primary" onclick="addRow()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        AÃ±adir tarjeta
      </button>
      <button class="btn" onclick="saveDeck()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Guardar
      </button>
      <button class="btn" onclick="exportCSV()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Exportar CSV
      </button>
      <button class="btn btn-danger" onclick="confirmDeleteDeck()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
        Eliminar mazo
      </button>
      <span style="font-size:0.78rem;color:var(--muted);margin-left:4px;" id="editorCardCount"></span>
    </div>
    <table class="editor-table">
      <thead><tr><th style="width:36px">#</th><th>Pregunta</th><th>Respuesta</th><th style="width:40px"></th></tr></thead>
      <tbody id="editorBody"></tbody>
    </table>
  </div>

  <!-- VIEW: IMPORT -->
  <div class="view hidden" id="view-import">
    <div class="drop-zone" id="dropZone" onclick="document.getElementById('csvFile').click()">
      <div class="drop-icon">ğŸ“‚</div>
      <div class="drop-text"><strong>Haz clic o arrastra un archivo CSV</strong><br>Formato: columna 1 = Pregunta, columna 2 = Respuesta<br>El separador puede ser coma o punto y coma</div>
    </div>
    <input type="file" id="csvFile" accept=".csv,.txt" onchange="handleFileInput(event)">
    <div id="importPreview" class="hidden">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <div>
          <div style="font-size:1rem;font-weight:500;" id="previewTitle">Vista previa</div>
          <div style="font-size:0.8rem;color:var(--muted);" id="previewMeta"></div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary" onclick="confirmImport()">Importar como nuevo mazo</button>
          <button class="btn" onclick="cancelImport()">Cancelar</button>
        </div>
      </div>
      <table class="editor-table">
        <thead><tr><th>#</th><th>Pregunta</th><th>Respuesta</th></tr></thead>
        <tbody id="previewBody"></tbody>
      </table>
    </div>
  </div>

  <!-- VIEW: PDFs -->
  <div class="view hidden" id="view-pdfs">
    <div class="drop-zone-pdf" id="dropZonePdf" onclick="document.getElementById('pdfFileInput').click()">
      <div class="drop-icon">ğŸ“„</div>
      <div class="drop-text"><strong>Haz clic o arrastra un PDF</strong><br>Puedes verlo y generar flashcards automÃ¡ticamente con IA</div>
    </div>
    <input type="file" id="pdfFileInput" accept=".pdf" onchange="handlePdfInput(event)">
    <div class="section-title" id="pdfSectionTitle" style="display:none">Mis resÃºmenes</div>
    <div class="pdf-grid" id="pdfGrid"></div>
  </div>

  <!-- VIEW: TESTS -->
  <div class="view hidden" id="view-tests">
    <div class="test-drop-zone" id="dropZoneTest" onclick="document.getElementById('testFileInput').click()">
      <div class="drop-icon">ğŸ“</div>
      <div class="drop-text"><strong>Haz clic o arrastra un Word (.docx) o PDF</strong><br>La IA generarÃ¡ un test interactivo con correcciÃ³n instantÃ¡nea y explicaciones</div>
    </div>
    <input type="file" id="testFileInput" accept=".docx,.pdf" onchange="handleTestFileInput(event)">
    <div id="testGeneratingArea" style="display:none;text-align:center;padding:3rem;">
      <div class="spinner" style="width:32px;height:32px;border-width:3px;margin:0 auto 16px;"></div>
      <div style="font-size:0.95rem;color:var(--muted);" id="testGenStatus">Analizando el documento...</div>
    </div>
    <div id="savedTestsSection" style="display:none;">
      <div class="section-title">Tests guardados</div>
      <div class="saved-tests-grid" id="savedTestsGrid"></div>
    </div>
  </div>

  <!-- VIEW: TAKING TEST -->
  <div class="view hidden" id="view-takingtest">
    <div class="test-header">
      <div class="test-title-bar" id="testTakingTitle">Test</div>
      <div class="test-progress-wrap"><div class="test-progress-bar" id="testProgressBar" style="width:0%"></div></div>
      <div class="test-counter" id="testCounter">1 / 1</div>
    </div>
    <div id="testQuestionArea"></div>
    <div id="testResultsArea" style="display:none;"></div>
  </div>

</main>

<!-- PDF VIEWER OVERLAY -->
<div class="pdf-viewer-overlay" id="pdfViewerOverlay">
  <div class="pdf-viewer-bar">
    <div class="pdf-viewer-title" id="pdfViewerTitle">Documento</div>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="btn" onclick="closePdfViewer()">âœ• Cerrar</button>
    </div>
  </div>
  <div class="pdf-viewer-body">
    <iframe id="pdfViewerFrame" title="PDF Viewer"></iframe>
  </div>
</div>

<!-- MODALS -->
<div class="overlay" id="overlay-newdeck">
  <div class="modal">
    <div class="modal-title">Nuevo mazo</div>
    <div class="modal-field">
      <label class="modal-label">Nombre del mazo</label>
      <input class="modal-input" id="newDeckName" placeholder="Ej: AnatomÃ­a, Historia..." onkeydown="if(event.key==='Enter')createDeck()">
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('overlay-newdeck')">Cancelar</button>
      <button class="btn btn-primary" onclick="createDeck()">Crear</button>
    </div>
  </div>
</div>


<div class="overlay" id="overlay-deletedeck">  <div class="modal">
    <div class="modal-title">Eliminar mazo</div>
    <p style="color:var(--muted);font-size:0.9rem;line-height:1.6;margin-bottom:20px;">Â¿Seguro que quieres eliminar el mazo <strong id="deleteDeckNameSpan" style="color:var(--text)"></strong>? Esta acciÃ³n no se puede deshacer.</p>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('overlay-deletedeck')">Cancelar</button>
      <button class="btn btn-danger" onclick="deleteDeck()">Eliminar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  decks: {},       // { id: { name, cards: [{q,a}] } }
  stats: { sessions:0, lastScore:null },
  currentView: 'dashboard',
  editingDeckId: null,
  studyDeckId: null,
};

// Default deck: the celador cards
const DEFAULT_DECK_ID = 'celador_2003';
const DEFAULT_CARDS = [
["Â¿QuÃ© ley aprobÃ³ en 2003 el Estatuto Marco del personal estatutario de los servicios de salud?","La Ley 55/2003, de 16 de diciembre."],
["SegÃºn la disposiciÃ³n transitoria sexta de la Ley 55/2003, Â¿quÃ© norma sigue regulando las funciones de los celadores?","La Orden de 5 de julio de 1971."],
["FunciÃ³n del celador: Â¿A quiÃ©nes debe orientar el celador las consultas sobre diagnÃ³sticos o pronÃ³sticos de los enfermos?","Al mÃ©dico encargado de la asistencia del enfermo."],
["Â¿En quÃ© casos realizarÃ¡ el celador labores de limpieza de forma excepcional?","Cuando el personal femenino no sea idÃ³neo por peso de los objetos o dificultad de manejo."],
["En relaciÃ³n con los animales de laboratorio, Â¿cuÃ¡l es la responsabilidad del celador?","Su alimentaciÃ³n, limpieza de jaulas y aseo antes y despuÃ©s de pruebas experimentales."],
["Â¿A quiÃ©n corresponde el traslado de los cadÃ¡veres al mortuorio?","Al celador."],
["En la prÃ¡ctica de autopsias, Â¿quÃ© limitaciÃ³n tiene el celador respecto al uso de material?","No puede hacer uso de instrumental alguno sobre el cadÃ¡ver."],
["Â¿QuÃ© figura ejerce la jefatura del personal de celadores por delegaciÃ³n del Administrador?","El Jefe de Personal Subalterno."],
["Â¿QuiÃ©n es el encargado de informar a los familiares de un fallecido sobre los trÃ¡mites para el enterramiento?","El Jefe de Personal Subalterno."],
["SegÃºn el texto, Â¿quÃ© factor determina si un servicio de atenciÃ³n al usuario es de calidad o no?","El grado de satisfacciÃ³n del usuario."],
["Â¿QuÃ© porcentaje de la comunicaciÃ³n representa la comunicaciÃ³n no verbal segÃºn el documento?","El 75%."],
["Tipo de usuario: Â¿CÃ³mo debe actuar el profesional ante un usuario 'Prepotente'?","No discutir, mostrar interÃ©s por sus argumentos y pedirle su opiniÃ³n."],
["Tipo de usuario: Â¿QuÃ© actitud es la correcta ante un usuario 'Desconfiado'?","Respetar sus ideas sin contradecirle y no afirmar nada que no se pueda demostrar."],
["Tipo de usuario: Â¿CÃ³mo se debe tratar a un usuario 'Discrepador'?","No entrar en provocaciones y argumentar a partir de sus propias palabras."],
["Tipo de usuario: Â¿CuÃ¡l es la estrategia adecuada para atender a un usuario 'Indeciso'?","Ofrecer informaciÃ³n precisa y correcta, valorando su tiempo."],
["Tipo de usuario: Â¿CÃ³mo debe actuar el celador ante un usuario 'Agresivo'?","Escucharlo, llamarlo por su nombre si es posible y tratar de razonar la situaciÃ³n con comprensiÃ³n."],
["En la atenciÃ³n telefÃ³nica, Â¿cuÃ¡l es el nÃºmero mÃ¡ximo de tonos recomendados antes de contestar?","Tres tonos (siendo lo ideal al segundo)."],
["Â¿QuÃ© se entiende por 'escucha activa' en la relaciÃ³n celador-paciente?","Comportamientos y expresiones que comunican al enfermo que se ha entendido su mensaje."],
["Â¿En quÃ© consiste la 'escucha pasiva'?","Demostrar comprensiÃ³n del mensaje mediante gestos, sonrisas o movimientos, sin usar el lenguaje verbal."],
["Barrera de comunicaciÃ³n: El uso de tecnicismos o tÃ©rminos mÃ©dicos ante un paciente se clasifica como una barrera _____.","SemÃ¡ntica"],
["Â¿CuÃ¡l es la primera fase de una relaciÃ³n de ayuda interpersonal entre celador y paciente?","La fase receptiva o de contacto."],
["Concepto: Asertividad","Capacidad de defender los propios derechos y opiniones respetando simultÃ¡neamente los de los demÃ¡s."],
["Â¿QuÃ© elemento de la comunicaciÃ³n se define como la respuesta que el receptor envÃ­a al emisor?","RetroalimentaciÃ³n o Feedback."],
["Estilo de comunicaciÃ³n: Â¿QuÃ© caracteriza al estilo de comunicaciÃ³n 'Pasivo'?","Actitud conformista, tono de voz bajo y evitar confrontaciones a toda costa."],
["Estilo de comunicaciÃ³n: Â¿QuÃ© define al estilo 'Agresivo'?","Tratar de imponer el criterio propio mediante amenazas, interrupciones o invasiÃ³n del espacio vital."],
["Al comunicarse con personas mayores, Â¿por quÃ© es fundamental mantener el contacto visual frontal?","Para compensar posibles pÃ©rdidas sensoriales (visiÃ³n o audiciÃ³n) y asegurar la comodidad del usuario."],
["Al dirigirse a una persona con discapacidad auditiva acompaÃ±ada de un intÃ©rprete, Â¿a quiÃ©n debe mirar el profesional?","Directamente a la persona con discapacidad auditiva."],
["Â¿QuÃ© tipo de lenguaje se recomienda usar con personas con discapacidad visual?","Un lenguaje explÃ­cito en sÃ­ mismo, ya que no perciben los gestos."],
["En el caso de la discapacidad fÃ­sica, Â¿cuÃ¡l debe ser la premisa del personal antes de prestar ayuda?","Actuar con naturalidad y preguntar directamente al usuario si necesita ayuda."],
["Â¿QuÃ© define a un conflicto 'Funcional' o constructivo?","Aquel que permite ver problemas nuevos, tomar mejores decisiones y fomentar la creatividad."],
["Â¿QuÃ© define a un conflicto 'Disfuncional' o destructivo?","Aquel que consume energÃ­a personal, daÃ±a la cohesiÃ³n del grupo y crea un ambiente negativo."],
["Estrategia de resoluciÃ³n: Â¿En quÃ© consiste la tÃ©cnica de 'Coexistencia pacÃ­fica'?","En encontrar puntos en comÃºn entre las partes para llegar a un acuerdo facilitando la informaciÃ³n."],
["Estrategia de resoluciÃ³n: Â¿QuÃ© implica la tÃ©cnica de 'Compromiso'?","Enfrentar el conflicto mediante un acuerdo sobre las diferencias para trabajar en armonÃ­a."],
["Survillance: Â¿A quiÃ©n corresponde estatutariamente la vigilancia de los exteriores del hospital durante el dÃ­a?","Al jardinero."],
["Survillance: Â¿QuiÃ©n debe encargarse de la vigilancia nocturna del interior y exterior del edificio?","El celador."],
["Â¿CuÃ¡ntos pases de visita entrega habitualmente el servicio de admisiÃ³n de ingresos por paciente?","Dos pases."],
["Â¿CuÃ¡l es la validez temporal general de un pase de visita estÃ¡ndar?","Un mes."],
["Â¿QuiÃ©n autoriza y quiÃ©n expide el pase permanente de 24 horas?","Lo autoriza el facultativo y lo expide la supervisora."],
["Â¿QuÃ© edad mÃ­nima se requiere para entrar como visita al hospital sin autorizaciÃ³n especial?","12 aÃ±os."],
["Â¿QuÃ© Ãºnicos animales tienen permitido el acceso al interior del hospital?","Los perros de asistencia (perros guÃ­a)."],
["Â¿CuÃ¡l es la responsabilidad del celador respecto a los pacientes que reciben el alta?","Trasladarlos en silla de ruedas o camilla hasta la salida del centro."],
["Â¿QuiÃ©n debe acompaÃ±ar al celador en el traslado de una mujer con parto iniciado hacia los paritorios?","Personal sanitario."],
["Â¿QuÃ© profesional se encarga especÃ­ficamente de realizar el recorrido para recoger documentaciÃ³n por las secretarÃ­as de planta?","El celador de correo interno."],
["En el traslado de documentos por correo interno, Â¿quÃ© carÃ¡cter no pueden tener estos envÃ­os?","CarÃ¡cter de urgente (ya que el celador debe seguir su ruta establecida)."],
["Procedimiento: Â¿CÃ³mo debe actuar el celador si un visitante intenta introducir alimentos no permitidos?","Prohibir la entrada de los alimentos, sin obligaciÃ³n de custodiarlos en la conserjerÃ­a."],
["Â¿CuÃ¡l es la funciÃ³n del celador en relaciÃ³n con el mobiliario de la instituciÃ³n?","Trasladar los aparatos o el mobiliario que se requiera de unos servicios a otros."],
["En el quirÃ³fano, Â¿a quÃ© Ã³rdenes debe someterse el celador ademÃ¡s de las de sus superiores jerÃ¡rquicos?","A las de los mÃ©dicos, supervisoras o enfermeras."],
["FunciÃ³n del celador: Â¿De quÃ© debe dar cuenta el celador respecto a la conservaciÃ³n del edificio?","De los desperfectos o anomalÃ­as encontrados en la limpieza y material."],
["Â¿QuÃ© profesional es responsable de constatar que el personal de oficio cumple el horario establecido?","El Jefe de Personal Subalterno."],
["En la gestiÃ³n de conflictos, Â¿quÃ© significa 'responder sin enojo'?","Mantener la calma para bajar los decibeles emocionales y dar una respuesta razonada."],
["Barrera de comunicaciÃ³n: Â¿QuÃ© es la 'redundancia'?","La apariciÃ³n de elementos en el mensaje que no aportan informaciÃ³n nueva."],
["Â¿QuiÃ©n debe encargarse del rasurado de pacientes masculinos antes de una cirugÃ­a si no hay peluquero?","El celador."],
["Â¿CuÃ¡l es la actitud correcta ante un usuario 'Imitador'?","Darle seguridad y confianza, preocupÃ¡ndose por Ã©l sin decidir en su lugar."],
["En la atenciÃ³n presencial, Â¿quÃ© carÃ¡cter tiene la informaciÃ³n proporcionada por el celador?","CarÃ¡cter orientativo (no tiene consideraciÃ³n jurÃ­dica ni normativa)."],
["Regla de escucha activa: Â¿QuÃ© acciÃ³n demuestra interÃ©s tras la intervenciÃ³n del paciente?","Resumir lo que ha dicho resaltando los aspectos mÃ¡s importantes."],
["Â¿Bajo quÃ© circunstancias el celador ayuda a colocar o retirar cuÃ±as para excretas?","Cuando el enfermo no pueda ser movido solo por la enfermera o ayudante."],
["FunciÃ³n de vigilancia: Â¿QuÃ© debe hacer el celador si un visitante presenta signos de embriaguez?","Prohibirle la entrada a la instituciÃ³n."],
["Â¿QuÃ© debe hacer el celador de puerta al observar un paquete sospechoso portado por alguien ajeno?","Ejercer un control discreto y comunicarlo al Jefe de Personal Subalterno."],
["Â¿QuiÃ©n es el responsable de avisar al servicio de atenciÃ³n al paciente cuando un enfermo entra en quirÃ³fano?","El celador."],
["En caso de ausencia del peluquero, Â¿a quÃ© pacientes masculinos puede rasurar el celador?","A aquellos que vayan a ser sometidos a intervenciones quirÃºrgicas."],
["Â¿QuiÃ©n se encarga del manejo de las fotocopiadoras en el servicio de reprografÃ­a de un hospital?","Los celadores."],
["Si un celador detecta una persiana rota, Â¿cuÃ¡l es su deber inmediato segÃºn sus funciones?","Dar cuenta a sus inmediatos superiores del desperfecto."],
["Â¿QuÃ© debe hacer el celador de vigilancia si detecta un conflicto grave con un intruso?","Requerir la presencia del personal de seguridad."],
["Â¿A quiÃ©n corresponde la apertura y cierre de la puerta principal en los horarios establecidos?","Al celador de puerta."],
["Â¿CuÃ¡l es la funciÃ³n del celador en la puerta de personal?","Regular la entrada del personal durante los cambios de turno."],
["En la puerta de rehabilitaciÃ³n, Â¿quÃ© tarea adicional suele realizar el celador?","Avisar a un compaÃ±ero para el traslado de pacientes al interior del servicio."],
["Concepto: NegociaciÃ³n formal","Serie de ofertas y contraofertas para elaborar posiciones hasta llegar a un acuerdo."],
["Â¿QuÃ© profesional debe vigilar la compostura y el uso del uniforme del personal a su cargo?","El Jefe de Personal Subalterno."],
["Â¿QuÃ© debe evitar el celador al hablar con un paciente para no generar desconfianza?","Presionarlo para que hable o interrumpirlo cuando expresa sentimientos."],
["En la comunicaciÃ³n con personas con discapacidad fÃ­sica, Â¿quÃ© debe evitar el profesional respecto a la lesiÃ³n?","Preguntar por el origen o las causas de su lesiÃ³n."],
["Al atender a colectivos con discapacidad psÃ­quica, Â¿quÃ© premisa debe seguirse?","Relacionarse con ellos segÃºn sus posibilidades y no segÃºn sus dificultades."],
["Â¿QuÃ© debe hacer el celador si un paciente intenta fumar en la habitaciÃ³n?","Vigilar el comportamiento y evitar que fume, velando por el orden de la instituciÃ³n."],
["Â¿QuiÃ©n es el responsable de que los enfermos no hagan uso indebido de las ropas de la instituciÃ³n?","El celador, al igual que el resto del personal."],
["Â¿De quÃ© se encarga el celador en los quirÃ³fanos experimentales?","Del cuidado, alimentaciÃ³n y limpieza de los animales utilizados."],
["Â¿QuÃ© documento otorga validez a las funciones del celador del aÃ±o 1971?","La disposiciÃ³n transitoria sexta de la Ley 55/2003."]
];

// Study session vars
let studyCards = [];
let studyIdx = 0;
let studyGood = 0, studyBad = 0;
let studyFlipped = false;

// Import preview
let importPreviewCards = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://pkrvgctsjbcytlfdkvyj.supabase.co';
const SB_KEY = 'sb_publishable_ca2_-a8KIim31slnIe5Ulw_d4MMZ3rO';

async function sbFetch(path, options={}) {
  const res = await fetch(SB_URL + path, {
    ...options,
    headers: {
      'apikey': SB_KEY,
      'Authorization': 'Bearer ' + SB_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation',
      ...(options.headers||{})
    }
  });
  if (!res.ok) {
    const err = await res.json().catch(()=>({}));
    throw new Error(err.message || 'Error Supabase ' + res.status);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : [];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSISTENCE (Supabase)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadState() {
  try {
    // Load decks
    const decks = await sbFetch('/rest/v1/decks?select=*');
    decks.forEach(d => { state.decks[d.id] = { name: d.name, cards: d.cards }; });
    // Load stats
    const stats = await sbFetch('/rest/v1/stats?id=eq.1&select=*');
    if (stats[0]) { state.stats.sessions = stats[0].sessions||0; state.stats.lastScore = stats[0].last_score; }
  } catch(e) { console.warn('Supabase load error:', e); }

  // Ensure default deck exists
  if (!state.decks[DEFAULT_DECK_ID]) {
    state.decks[DEFAULT_DECK_ID] = {
      name: 'Celador â€” Ley 55/2003',
      cards: DEFAULT_CARDS.map(([q,a]) => ({q,a}))
    };
    await saveState();
  }
}

async function saveState() {
  try {
    // Upsert all decks
    const rows = Object.entries(state.decks).map(([id,d]) => ({ id, name: d.name, cards: d.cards }));
    if (rows.length > 0) {
      await sbFetch('/rest/v1/decks', {
        method: 'POST',
        headers: { 'Prefer': 'resolution=merge-duplicates,return=minimal' },
        body: JSON.stringify(rows)
      });
    }
    // Upsert stats
    await sbFetch('/rest/v1/stats', {
      method: 'POST',
      headers: { 'Prefer': 'resolution=merge-duplicates,return=minimal' },
      body: JSON.stringify([{ id:1, sessions: state.stats.sessions, last_score: state.stats.lastScore }])
    });
  } catch(e) { console.warn('Supabase save error:', e); }
}

async function deleteDeckFromDB(id) {
  try { await sbFetch(`/rest/v1/decks?id=eq.${id}`, { method:'DELETE' }); } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEWS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showView(name, deckId) {
  ['dashboard','study','editor','import','pdfs','tests','takingtest'].forEach(v => {
    document.getElementById('view-'+v).classList.add('hidden');
  });
  ['nav-dashboard','nav-import','nav-pdfs','nav-tests'].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.classList.remove('active');
  });
  document.getElementById('view-'+name).classList.remove('hidden');
  state.currentView = name;

  const actions = document.getElementById('topbarActions');
  actions.innerHTML = '';

  if (name === 'dashboard') {
    document.getElementById('topbarTitle').textContent = 'Inicio';
    document.getElementById('nav-dashboard').classList.add('active');
    renderDashboard();
  } else if (name === 'study') {
    const deck = state.decks[deckId];
    state.studyDeckId = deckId;
    document.getElementById('topbarTitle').textContent = deck.name;
    actions.innerHTML = `<button class="btn" onclick="showView('editor','${deckId}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Editar</button>`;
    startStudy(deckId);
  } else if (name === 'editor') {
    const deck = state.decks[deckId];
    state.editingDeckId = deckId;
    document.getElementById('topbarTitle').textContent = 'Editar: ' + deck.name;
    actions.innerHTML = `<button class="btn btn-primary" onclick="studyFromEditor()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px"><polygon points="5 3 19 12 5 21 5 3"/></svg>Estudiar</button>`;
    renderEditor(deckId);
  } else if (name === 'import') {
    document.getElementById('topbarTitle').textContent = 'Importar CSV';
    document.getElementById('nav-import').classList.add('active');
    document.getElementById('importPreview').classList.add('hidden');
  } else if (name === 'pdfs') {
    document.getElementById('topbarTitle').textContent = 'Mis PDFs';
    document.getElementById('nav-pdfs').classList.add('active');
    loadPdfsFromDB().then(renderPdfGrid);
  } else if (name === 'tests') {
    document.getElementById('topbarTitle').textContent = 'Tests';
    document.getElementById('nav-tests').classList.add('active');
    document.getElementById('dropZoneTest').style.display = '';
    document.getElementById('testGeneratingArea').style.display = 'none';
    loadSavedTestsAsync().then(renderSavedTests);
  } else if (name === 'takingtest') {
    document.getElementById('topbarTitle').textContent = savedTests[activeTest.id]?.name || 'Test';
    document.getElementById('nav-tests').classList.add('active');
    renderTestQuestion();
  }

  renderSidebar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  const deckIds = Object.keys(state.decks);
  const totalCards = deckIds.reduce((s,id) => s + state.decks[id].cards.length, 0);
  document.getElementById('statDecks').textContent = deckIds.length;
  document.getElementById('statCards').textContent = totalCards;
  document.getElementById('statStudied').textContent = state.stats.sessions;
  document.getElementById('statScore').textContent = state.stats.lastScore !== null ? state.stats.lastScore + '%' : 'â€”';

  const grid = document.getElementById('deckCardsGrid');
  const empty = document.getElementById('emptyState');
  grid.innerHTML = '';

  if (deckIds.length === 0) { empty.style.display='block'; return; }
  empty.style.display='none';

  deckIds.forEach(id => {
    const d = state.decks[id];
    const div = document.createElement('div');
    div.className = 'deck-card';
    div.innerHTML = `
      <div class="deck-card-title">${escHtml(d.name)}</div>
      <div class="deck-card-meta">${d.cards.length} tarjetas</div>
      <div class="deck-card-actions">
        <button class="btn btn-primary" onclick="event.stopPropagation();showView('study','${id}')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><polygon points="5 3 19 12 5 21 5 3"/></svg>Estudiar
        </button>
        <button class="btn" onclick="event.stopPropagation();showView('editor','${id}')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Editar
        </button>
      </div>`;
    grid.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSidebar() {
  const list = document.getElementById('deckList');
  const inner = Object.keys(state.decks).map(id => {
    const d = state.decks[id];
    const active = (state.currentView==='study'||state.currentView==='editor') && (state.studyDeckId===id||state.editingDeckId===id);
    return `<button class="deck-item ${active?'active':''}" onclick="showView('study','${id}')">
      <span class="deck-name">${escHtml(d.name)}</span>
      <span class="deck-count">${d.cards.length}</span>
    </button>`;
  }).join('');
  list.innerHTML = `<div class="deck-label">Mis mazos</div>${inner}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startStudy(deckId) {
  const deck = state.decks[deckId];
  studyCards = shuffleArr([...deck.cards]);
  studyIdx = 0; studyGood = 0; studyBad = 0; studyFlipped = false;
  document.getElementById('studyDeckName').textContent = deck.name;
  document.getElementById('studyFinish').classList.add('hidden');
  document.getElementById('studyCardArea').style.display = '';
  renderStudyCard();
}

function shuffleArr(arr) {
  for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
  return arr;
}

function renderStudyCard() {
  const c = studyCards[studyIdx];
  document.getElementById('faceQ').textContent = c.q;
  document.getElementById('faceA').textContent = c.a;
  document.getElementById('studyCounter').textContent = `${studyIdx+1} / ${studyCards.length}`;
  const pct = (studyIdx / studyCards.length) * 100;
  document.getElementById('studyProgress').style.width = pct + '%';
  document.getElementById('studyGood').textContent = studyGood;
  document.getElementById('studyBad').textContent = studyBad;
  // Reset flip
  studyFlipped = false;
  document.getElementById('card3d').classList.remove('flipped');
  document.getElementById('studyActions').classList.remove('show');
}

function flipCard() {
  if (studyFlipped) return;
  studyFlipped = true;
  document.getElementById('card3d').classList.add('flipped');
  setTimeout(() => document.getElementById('studyActions').classList.add('show'), 320);
}

function rateCard(good) {
  if (good) studyGood++; else studyBad++;
  if (studyIdx < studyCards.length - 1) {
    studyIdx++;
    renderStudyCard();
  } else {
    finishStudy();
  }
}

function nextCardNav() {
  if (studyIdx < studyCards.length - 1) { studyIdx++; renderStudyCard(); }
  else finishStudy();
}

function prevCard() {
  if (studyIdx > 0) { studyIdx--; renderStudyCard(); }
}

function finishStudy() {
  const total = studyGood + studyBad;
  const pct = total ? Math.round((studyGood/total)*100) : 0;
  state.stats.sessions++;
  state.stats.lastScore = pct;
  saveState();
  document.getElementById('studyProgress').style.width = '100%';
  document.getElementById('studyCardArea').style.display = 'none';
  document.getElementById('studyFinish').classList.remove('hidden');
  document.getElementById('finishScore').textContent = pct + '%';
  const msgs = [
    [80, `Â¡Excelente! SabÃ­as ${studyGood} de ${total}. EstÃ¡s listo.`],
    [50, `Bien encaminado. SabÃ­as ${studyGood} de ${total}. Repasa los que fallaste.`],
    [0,  `SabÃ­as ${studyGood} de ${total}. La repeticiÃ³n es la clave, Â¡vuelve a intentarlo!`]
  ];
  document.getElementById('finishMsg').textContent = msgs.find(([t])=>pct>=t)[1];
}

function shuffleAndRestart() { startStudy(state.studyDeckId); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDITOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderEditor(deckId) {
  const deck = state.decks[deckId];
  const tbody = document.getElementById('editorBody');
  tbody.innerHTML = '';
  deck.cards.forEach((c, i) => {
    const tr = document.createElement('tr');
    tr.dataset.idx = i;
    tr.innerHTML = `
      <td class="row-num">${i+1}</td>
      <td><textarea class="cell-input" rows="2" data-field="q" data-idx="${i}" onchange="updateCard(${i},'q',this.value)">${escHtml(c.q)}</textarea></td>
      <td><textarea class="cell-input" rows="2" data-field="a" data-idx="${i}" onchange="updateCard(${i},'a',this.value)">${escHtml(c.a)}</textarea></td>
      <td><button class="del-row" onclick="deleteRow(${i})" title="Eliminar">âœ•</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('editorCardCount').textContent = deck.cards.length + ' tarjetas';
}

function updateCard(idx, field, val) {
  const deck = state.decks[state.editingDeckId];
  deck.cards[idx][field] = val;
}

function addRow() {
  const deck = state.decks[state.editingDeckId];
  deck.cards.push({q:'', a:''});
  saveState();
  renderEditor(state.editingDeckId);
  // Scroll to bottom
  const tbody = document.getElementById('editorBody');
  const last = tbody.lastElementChild;
  if (last) { last.scrollIntoView({behavior:'smooth'}); last.querySelector('textarea').focus(); }
}

function deleteRow(idx) {
  const deck = state.decks[state.editingDeckId];
  deck.cards.splice(idx, 1);
  saveState();
  renderEditor(state.editingDeckId);
}

function saveDeck() {
  // Sync all textarea values
  const deck = state.decks[state.editingDeckId];
  document.querySelectorAll('#editorBody textarea').forEach(ta => {
    const i = +ta.dataset.idx;
    const f = ta.dataset.field;
    if (deck.cards[i]) deck.cards[i][f] = ta.value;
  });
  // Remove completely empty rows
  deck.cards = deck.cards.filter(c => c.q.trim() || c.a.trim());
  saveState();
  renderEditor(state.editingDeckId);
  renderSidebar();
  toast('Mazo guardado', 'ok');
}

function studyFromEditor() {
  saveDeck();
  showView('study', state.editingDeckId);
}

function exportCSV() {
  saveDeck();
  const deck = state.decks[state.editingDeckId];
  const rows = deck.cards.map(c => `"${c.q.replace(/"/g,'""')}","${c.a.replace(/"/g,'""')}"`).join('\n');
  const blob = new Blob([rows], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = deck.name.replace(/[^a-z0-9]/gi,'_') + '.csv';
  a.click();
  toast('CSV exportado', 'ok');
}

function confirmDeleteDeck() {
  document.getElementById('deleteDeckNameSpan').textContent = state.decks[state.editingDeckId].name;
  openModal('overlay-deletedeck');
}

async function deleteDeck() {
  const id = state.editingDeckId;
  delete state.decks[id];
  await deleteDeckFromDB(id);
  closeModal('overlay-deletedeck');
  showView('dashboard');
  toast('Mazo eliminado', 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMPORT CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dropZone = document.getElementById('dropZone');
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag');
  const file = e.dataTransfer.files[0];
  if (file) processCSVFile(file);
});

function handleFileInput(e) { const f = e.target.files[0]; if(f) processCSVFile(f); e.target.value=''; }

function processCSVFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result;
    const cards = parseCSV(text);
    if (cards.length === 0) { toast('No se encontraron tarjetas en el CSV', 'err'); return; }
    importPreviewCards = cards;
    showImportPreview(file.name, cards);
  };
  reader.readAsText(file, 'UTF-8');
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim());
  const cards = [];
  for (const line of lines) {
    // Try quoted CSV first
    const m = line.match(/^"((?:[^"]|"")*)"[,;]"((?:[^"]|"")*)"$/);
    if (m) {
      cards.push({ q: m[1].replace(/""/g,'"'), a: m[2].replace(/""/g,'"') });
      continue;
    }
    // Fallback: split by ; or ,
    const sep = line.includes(';') ? ';' : ',';
    const idx = line.indexOf(sep);
    if (idx > 0) {
      const q = line.slice(0, idx).replace(/^"|"$/g,'').trim();
      const a = line.slice(idx+1).replace(/^"|"$/g,'').trim();
      if (q) cards.push({q, a});
    }
  }
  return cards;
}

function showImportPreview(fname, cards) {
  document.getElementById('importPreview').classList.remove('hidden');
  document.getElementById('previewTitle').textContent = fname;
  document.getElementById('previewMeta').textContent = `${cards.length} tarjetas detectadas`;
  const tbody = document.getElementById('previewBody');
  tbody.innerHTML = cards.slice(0,10).map((c,i) =>
    `<tr><td class="row-num">${i+1}</td><td style="font-size:0.85rem;color:var(--text)">${escHtml(c.q)}</td><td style="font-size:0.85rem;color:var(--muted)">${escHtml(c.a)}</td></tr>`
  ).join('') + (cards.length>10 ? `<tr><td colspan="3" style="text-align:center;color:var(--muted);font-size:0.8rem;padding:10px">... y ${cards.length-10} mÃ¡s</td></tr>` : '');
}

function confirmImport() {
  if (importPreviewCards.length === 0) return;
  // Try to guess name from context â€” use default
  const id = 'deck_' + Date.now();
  const name = document.getElementById('previewTitle').textContent.replace(/\.csv$/i,'').replace(/_/g,' ');
  state.decks[id] = { name, cards: importPreviewCards };
  saveState();
  importPreviewCards = [];
  document.getElementById('importPreview').classList.add('hidden');
  toast(`Mazo "${name}" importado con Ã©xito`, 'ok');
  showView('dashboard');
}

function cancelImport() {
  importPreviewCards = [];
  document.getElementById('importPreview').classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DECKS MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewDeck() { document.getElementById('newDeckName').value=''; openModal('overlay-newdeck'); setTimeout(()=>document.getElementById('newDeckName').focus(),100); }

function createDeck() {
  const name = document.getElementById('newDeckName').value.trim();
  if (!name) { toast('Escribe un nombre para el mazo','err'); return; }
  const id = 'deck_' + Date.now();
  state.decks[id] = { name, cards: [] };
  saveState();
  closeModal('overlay-newdeck');
  showView('editor', id);
  toast('Mazo creado', 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer;
function toast(msg, type='') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2800);
}

// Close modals on overlay click
document.querySelectorAll('.overlay').forEach(o => {
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('show'); });
});

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (state.currentView !== 'study') return;
  if (document.getElementById('studyFinish').classList.contains('hidden') === false) return;
  if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); if (!studyFlipped) flipCard(); }
  if (e.key === 'ArrowRight') nextCardNav();
  if (e.key === 'ArrowLeft') prevCard();
  if (e.key === 's' && studyFlipped) rateCard(true);
  if (e.key === 'n' && studyFlipped) rateCard(false);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TESTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let savedTests = {}; // { id: { name, questions:[{text,type,options,correct,explanation}] } }
let activeTest = { id:null, questions:[], idx:0, answers:[], answered:false };

function loadSavedTests() {
  // Tests loaded async in showView('tests')
}
async function loadSavedTestsAsync() {
  try {
    const rows = await sbFetch('/rest/v1/tests?select=*&order=created_at.desc');
    savedTests = {};
    rows.forEach(r => { savedTests[r.id] = { name: r.name, questions: r.questions, created: r.created_at }; });
  } catch(e) { console.warn('Tests load error:', e); }
}
async function saveSavedTests() {
  // saved individually on create
}
async function saveTestToDB(id) {
  const t = savedTests[id];
  try {
    await sbFetch('/rest/v1/tests', {
      method: 'POST',
      headers: { 'Prefer': 'resolution=merge-duplicates,return=minimal' },
      body: JSON.stringify([{ id, name: t.name, questions: t.questions }])
    });
  } catch(e) { console.warn('Test save error:', e); }
}
async function deleteTestFromDB(id) {
  try { await sbFetch(`/rest/v1/tests?id=eq.${id}`, { method:'DELETE' }); } catch(e) {}
}

function handleTestFileInput(e) {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';
  if (file.size > 20*1024*1024) { toast('Archivo demasiado grande (mÃ¡x 20MB)', 'err'); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    const base64 = ev.target.result.split(',')[1];
    const isPdf = file.type === 'application/pdf' || file.name.endsWith('.pdf');
    const mediaType = isPdf ? 'application/pdf' : 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
    generateTestFromDoc(file.name.replace(/\.(docx|pdf)$/i,''), base64, mediaType);
  };
  reader.readAsDataURL(file);
}

// Drag & drop for test zone
document.addEventListener('DOMContentLoaded', () => {
  const dz = document.getElementById('dropZoneTest');
  if (!dz) return;
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('drag');
    const file = e.dataTransfer.files[0];
    if (file) {
      const fake = { target:{files:[file],value:''} };
      handleTestFileInput(fake);
    } else { toast('Formato no vÃ¡lido. Usa .docx o .pdf', 'err'); }
  });
});

async function generateTestFromDoc(name, base64, mediaType) {
  document.getElementById('dropZoneTest').style.display = 'none';
  document.getElementById('testGeneratingArea').style.display = '';
  document.getElementById('testGenStatus').textContent = 'Analizando el documento con IA...';

  try {
    const isPdf = mediaType === 'application/pdf';
    const docContent = isPdf
      ? { type:'document', source:{ type:'base64', media_type:'application/pdf', data:base64 } }
      : { type:'document', source:{ type:'base64', media_type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document', data:base64 } };

    document.getElementById('testGenStatus').textContent = 'Generando preguntas...';

    const response = await fetch('/.netlify/functions/aresbrain', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        
        max_tokens:5000,
        system:`Eres un experto en crear tests de evaluaciÃ³n. A partir del documento, genera preguntas de test variadas.
Responde ÃšNICAMENTE con JSON vÃ¡lido, sin texto adicional, sin bloques de cÃ³digo.
Formato exacto:
{"questions":[
  {"text":"pregunta","type":"multiple","options":["A) opciÃ³n","B) opciÃ³n","C) opciÃ³n","D) opciÃ³n"],"correct":"A","explanation":"ExplicaciÃ³n de por quÃ© A es correcta y las demÃ¡s no"},
  {"text":"pregunta","type":"truefalse","options":["Verdadero","Falso"],"correct":"Verdadero","explanation":"ExplicaciÃ³n"},
  ...
]}
Tipos permitidos: "multiple" (4 opciones A/B/C/D) y "truefalse".
Si el documento ya tiene preguntas de test, extrÃ¡elas directamente respetando las opciones originales. Si no, crea preguntas basadas en el contenido.
Las opciones de tipo "multiple" SIEMPRE deben empezar con "A) ", "B) ", "C) ", "D) ".
El campo "correct" debe ser exactamente "A", "B", "C" o "D" para multiple, o "Verdadero"/"Falso" para truefalse.
La explicaciÃ³n debe ser clara, educativa y mencionar por quÃ© las opciones incorrectas estÃ¡n mal. En espaÃ±ol.`,
        messages:[{
          role:'user',
          content:[
            docContent,
            { type:'text', text:'Genera entre 10 y 20 preguntas de test a partir de este documento. Si ya contiene preguntas, extrÃ¡elas todas. Responde solo con el JSON.' }
          ]
        }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'Error de la API');
    }

    const data = await response.json();
    const text = data.content.map(b=>b.text||'').join('');
    let parsed;
    try {
      const clean = text.replace(/```json|```/g,'').trim();
      parsed = JSON.parse(clean);
    } catch { throw new Error('No se pudo procesar la respuesta. IntÃ©ntalo de nuevo.'); }

    const questions = parsed.questions || [];
    if (questions.length === 0) throw new Error('No se generaron preguntas. IntÃ©ntalo de nuevo.');

    const id = 'test_' + Date.now();
    savedTests[id] = { name, questions, created: Date.now() };
    await saveTestToDB(id);

    document.getElementById('testGeneratingArea').style.display = 'none';
    document.getElementById('dropZoneTest').style.display = '';
    toast(`âœ… Test "${name}" creado con ${questions.length} preguntas`, 'ok');
    renderSavedTests();
    startTest(id);

  } catch(err) {
    document.getElementById('testGeneratingArea').style.display = 'none';
    document.getElementById('dropZoneTest').style.display = '';
    toast('Error: ' + err.message, 'err');
  }
}

function renderSavedTests() {
  const ids = Object.keys(savedTests);
  const sec = document.getElementById('savedTestsSection');
  const grid = document.getElementById('savedTestsGrid');
  sec.style.display = ids.length ? '' : 'none';
  grid.innerHTML = ids.map(id => {
    const t = savedTests[id];
    return `<div class="saved-test-card">
      <div class="saved-test-icon">ğŸ“</div>
      <div class="saved-test-name">${escHtml(t.name)}</div>
      <div class="saved-test-meta">${t.questions.length} preguntas</div>
      <div class="saved-test-actions">
        <button class="btn btn-primary" onclick="startTest('${id}')">â–¶ Hacer test</button>
        <button class="btn btn-danger" onclick="deleteTest('${id}')">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

async function deleteTest(id) {
  delete savedTests[id];
  await deleteTestFromDB(id);
  renderSavedTests();
  toast('Test eliminado', 'ok');
}

function startTest(id) {
  const t = savedTests[id];
  activeTest = { id, questions:[...t.questions], idx:0, answers:Array(t.questions.length).fill(null), answered:false };
  showView('takingtest', id);
}

// â”€â”€ TAKING TEST â”€â”€
function renderTestQuestion() {
  const { questions, idx, answered } = activeTest;
  const q = questions[idx];
  const total = questions.length;

  document.getElementById('testTakingTitle').textContent = savedTests[activeTest.id]?.name || 'Test';
  document.getElementById('testCounter').textContent = `${idx+1} / ${total}`;
  document.getElementById('testProgressBar').style.width = `${(idx/total)*100}%`;
  document.getElementById('testResultsArea').style.display = 'none';
  document.getElementById('testQuestionArea').style.display = '';

  const letters = ['A','B','C','D'];
  const optionsHtml = q.options.map((opt, i) => {
    const letter = q.type === 'truefalse' ? (i===0?'V':'F') : letters[i];
    return `<button class="option-btn" id="opt_${i}" onclick="selectOption(${i})">
      <span class="option-letter">${letter}</span>
      <span>${escHtml(opt)}</span>
    </button>`;
  }).join('');

  const typeBadge = q.type === 'truefalse' ? 'Verdadero / Falso' : 'OpciÃ³n mÃºltiple';

  document.getElementById('testQuestionArea').innerHTML = `
    <div class="question-card">
      <div class="question-num">Pregunta ${idx+1}<span class="question-type-badge">${typeBadge}</span></div>
      <div class="question-text">${escHtml(q.text)}</div>
      <div class="options-list">${optionsHtml}</div>
      <div class="feedback-box" id="feedbackBox"></div>
      <div class="next-btn-wrap" id="nextBtnWrap">
        <button class="btn btn-primary" onclick="nextTestQuestion()">
          ${idx < total-1 ? 'Siguiente â†’' : 'Ver resultados'}
        </button>
      </div>
    </div>`;
  activeTest.answered = false;
}

function selectOption(optIdx) {
  if (activeTest.answered) return;
  activeTest.answered = true;

  const q = activeTest.questions[activeTest.idx];
  const letters = ['A','B','C','D'];

  // Determine correct option index
  let correctIdx;
  if (q.type === 'truefalse') {
    correctIdx = q.options.findIndex(o => o === q.correct || (q.correct === 'Verdadero' && o === 'Verdadero') || (q.correct === 'Falso' && o === 'Falso'));
    if (correctIdx === -1) correctIdx = q.correct === 'Verdadero' ? 0 : 1;
  } else {
    correctIdx = letters.indexOf(q.correct);
    if (correctIdx === -1) {
      // maybe correct is the full option text
      correctIdx = q.options.findIndex(o => o === q.correct || o.startsWith(q.correct + ')') || o.startsWith(q.correct + ' '));
    }
  }

  const isCorrect = optIdx === correctIdx;
  activeTest.answers[activeTest.idx] = { chosen: optIdx, correct: correctIdx, isCorrect };

  // Style buttons
  q.options.forEach((_, i) => {
    const btn = document.getElementById(`opt_${i}`);
    if (!btn) return;
    btn.disabled = true;
    if (i === correctIdx) btn.classList.add(i === optIdx ? 'correct' : 'missed');
    else if (i === optIdx) btn.classList.add('wrong');
  });

  // Feedback
  const fb = document.getElementById('feedbackBox');
  fb.className = 'feedback-box show ' + (isCorrect ? 'ok' : 'ko');
  fb.innerHTML = `<strong>${isCorrect ? 'âœ“ Â¡Correcto!' : 'âœ— Incorrecto'}</strong>
    <div class="feedback-why">${escHtml(q.explanation || 'Sin explicaciÃ³n disponible.')}</div>`;

  // Show next button
  const nw = document.getElementById('nextBtnWrap');
  if (nw) setTimeout(() => nw.classList.add('show'), 200);
}

function nextTestQuestion() {
  const { questions, idx } = activeTest;
  if (idx < questions.length - 1) {
    activeTest.idx++;
    renderTestQuestion();
  } else {
    showTestResults();
  }
}

function showTestResults() {
  const { questions, answers } = activeTest;
  const correct = answers.filter(a => a && a.isCorrect).length;
  const total = questions.length;
  const pct = Math.round((correct/total)*100);
  const letters = ['A','B','C','D'];

  document.getElementById('testProgressBar').style.width = '100%';
  document.getElementById('testCounter').textContent = `${total} / ${total}`;
  document.getElementById('testQuestionArea').style.display = 'none';
  document.getElementById('testResultsArea').style.display = '';

  const msg = pct>=80 ? 'Â¡Excelente! Dominas el tema.' : pct>=60 ? 'Bien, pero repasa los fallos.' : 'Sigue estudiando, Â¡tÃº puedes!';

  const reviewHtml = questions.map((q, i) => {
    const ans = answers[i];
    if (!ans) return '';
    const isOk = ans.isCorrect;
    const chosenLabel = q.type==='truefalse' ? q.options[ans.chosen] : (q.options[ans.chosen] || 'â€”');
    const correctLabel = q.type==='truefalse' ? q.options[ans.correct] : (q.options[ans.correct] || q.correct);
    return `<div class="result-review-item ${isOk?'ok':'ko'}">
      <div class="result-q">${i+1}. ${escHtml(q.text)}</div>
      ${!isOk ? `<div class="result-your">Tu respuesta: ${escHtml(chosenLabel)}</div>` : ''}
      <div class="result-correct">${isOk?'âœ“':'Correcta:'} ${escHtml(correctLabel)}</div>
      ${!isOk ? `<div class="result-explanation">${escHtml(q.explanation||'')}</div>` : ''}
    </div>`;
  }).join('');

  document.getElementById('testResultsArea').innerHTML = `
    <div class="test-results">
      <div class="result-header">
        <div class="result-score-big">${pct}%</div>
        <div class="result-subtitle">Test completado</div>
        <div class="result-msg">${msg}</div>
        <div class="result-stats">
          <div class="result-stat g"><div class="result-stat-val">${correct}</div><div class="result-stat-lbl">Correctas</div></div>
          <div class="result-stat r"><div class="result-stat-val">${total-correct}</div><div class="result-stat-lbl">Incorrectas</div></div>
          <div class="result-stat"><div class="result-stat-val">${total}</div><div class="result-stat-lbl">Total</div></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <button class="btn" onclick="startTest(activeTest.id)">â†º Repetir test</button>
          <button class="btn btn-primary" onclick="showView('tests')">Volver a Tests</button>
        </div>
      </div>
      <div class="section-title">RevisiÃ³n detallada</div>
      <div class="result-review">${reviewHtml}</div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PDFs (Supabase Storage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pdfStore = {}; // { id: { name, dataUrl, base64, size, storagePath } }
let currentPdfId = null;


function handlePdfInput(e) {
  const file = e.target.files[0];
  if (!file) return;
  e.target.value = '';
  if (file.size > 20 * 1024 * 1024) { toast('El PDF es demasiado grande (mÃ¡x 20MB)', 'err'); return; }
  const reader = new FileReader();
  reader.onload = async ev => {
    const dataUrl = ev.target.result;
    const base64 = dataUrl.split(',')[1];
    const id = 'pdf_' + Date.now();
    const storagePath = id + '/' + file.name;
    pdfStore[id] = { name: file.name.replace(/\.pdf$/i,''), dataUrl, base64, size: file.size, storagePath };
    // Upload to Supabase Storage
    try {
      await fetch(`${SB_URL}/storage/v1/object/documents/${storagePath}`, {
        method: 'POST',
        headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/pdf' },
        body: file
      });
      // Save metadata to DB
      await sbFetch('/rest/v1/pdfs', {
        method: 'POST',
        headers: { 'Prefer': 'resolution=merge-duplicates,return=minimal' },
        body: JSON.stringify([{ id, name: pdfStore[id].name, size: file.size, storage_path: storagePath }])
      });
      toast(`PDF "${pdfStore[id].name}" guardado en la nube â˜ï¸`, 'ok');
    } catch(err) {
      toast('PDF cargado solo en memoria (error al guardar en nube)', 'err');
    }
    renderPdfGrid();
  };
  reader.readAsDataURL(file);
}

async function loadPdfsFromDB() {
  try {
    const rows = await sbFetch('/rest/v1/pdfs?select=*&order=created_at.desc');
    rows.forEach(r => {
      if (!pdfStore[r.id]) {
        // Stored in Supabase but not loaded yet â€” show as cloud entry
        pdfStore[r.id] = { name: r.name, size: r.size, storagePath: r.storage_path, dataUrl: null, base64: null, cloud: true };
      }
    });
  } catch(e) {}
}

async function downloadPdfFromCloud(id) {
  const p = pdfStore[id];
  if (!p || !p.storagePath) return false;
  try {
    toast('Descargando PDF...', '');
    const res = await fetch(`${SB_URL}/storage/v1/object/public/documents/${p.storagePath}`, {
      headers: { 'apikey': SB_KEY }
    });
    if (!res.ok) throw new Error('No se pudo descargar');
    const blob = await res.blob();
    const dataUrl = await new Promise(resolve => {
      const fr = new FileReader(); fr.onload = e => resolve(e.target.result); fr.readAsDataURL(blob);
    });
    pdfStore[id].dataUrl = dataUrl;
    pdfStore[id].base64 = dataUrl.split(',')[1];
    pdfStore[id].cloud = false;
    return true;
  } catch(e) { toast('Error al descargar el PDF', 'err'); return false; }
}

function renderPdfGrid() {
  const ids = Object.keys(pdfStore);
  const grid = document.getElementById('pdfGrid');
  const title = document.getElementById('pdfSectionTitle');
  title.style.display = ids.length ? '' : 'none';
  grid.innerHTML = ids.map(id => {
    const p = pdfStore[id];
    const kb = (p.size/1024).toFixed(0);
    const sizeStr = kb > 1024 ? (kb/1024).toFixed(1)+'MB' : kb+'KB';
    const cloudBadge = p.cloud ? `<span style="font-size:0.68rem;color:var(--accent);margin-left:4px;">â˜ï¸ nube</span>` : '';
    return `<div class="pdf-card">
      <div class="pdf-icon">ğŸ“„</div>
      <div class="pdf-name">${escHtml(p.name)}${cloudBadge}</div>
      <div class="pdf-meta">${sizeStr}</div>
      <div class="pdf-card-actions">
        <button class="btn btn-primary" onclick="openPdfViewer('${id}')">ğŸ‘ Ver</button>
        
        <button class="btn btn-pdf-delete" onclick="deletePdf('${id}')">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

async function openPdfViewer(id) {
  const p = pdfStore[id];
  if (!p) return;
  // If only in cloud, download first
  if (!p.dataUrl) {
    const ok = await downloadPdfFromCloud(id);
    if (!ok) return;
  }
  currentPdfId = id;
  document.getElementById('pdfViewerTitle').textContent = pdfStore[id].name;
  document.getElementById('pdfViewerFrame').src = pdfStore[id].dataUrl;
  document.getElementById('pdfViewerOverlay').classList.add('show');
  // Update sidebar last PDF
  document.getElementById('lastPdfSection').style.display = '';
  document.getElementById('lastPdfName').textContent = pdfStore[id].name;
  document.getElementById('lastPdfItem').dataset.pdfId = id;
}

function openLastPdf() {
  const id = document.getElementById('lastPdfItem').dataset.pdfId;
  if (id && pdfStore[id]) {
    openPdfViewer(id);
  } else {
    toast('El PDF ya no estÃ¡ cargado. Ve a "Mis PDFs" para subirlo de nuevo.', 'err');
    document.getElementById('lastPdfSection').style.display = 'none';
  }
}

function closePdfViewer() {
  document.getElementById('pdfViewerOverlay').classList.remove('show');
  document.getElementById('pdfViewerFrame').src = '';
}

// Drag & drop for PDF zone
  const p = pdfStore[id];
  delete pdfStore[id];
  renderPdfGrid();
  try {
    await sbFetch(`/rest/v1/pdfs?id=eq.${id}`, { method:'DELETE' });
    if (p?.storagePath) {
      await fetch(`${SB_URL}/storage/v1/object/documents/${p.storagePath}`, {
        method:'DELETE', headers:{ 'apikey':SB_KEY, 'Authorization':'Bearer '+SB_KEY }
      });
    }
  } catch(e) {}
  toast('PDF eliminado', 'ok');
}

// Drag & drop for PDF zone
document.addEventListener('DOMContentLoaded', () => {
  const dz = document.getElementById('dropZonePdf');
  if (!dz) return;
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('drag'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('drag');
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') {
      const fakeEv = { target: { files: [file], value: '' }, preventDefault:()=>{} };
      handlePdfInput(fakeEv);
    } else { toast('Por favor sube un archivo PDF', 'err'); }
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTheme() {
  const isLight = document.body.classList.toggle('light');
  document.getElementById('themeBtn').textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('aresbrain_theme', isLight ? 'light' : 'dark');
}

function loadTheme() {
  const t = localStorage.getItem('aresbrain_theme');
  if (t === 'light') {
    document.body.classList.add('light');
    document.getElementById('themeBtn').textContent = 'â˜€ï¸';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
  loadTheme();
  // Show loading overlay
  document.body.insertAdjacentHTML('beforeend', `
    <div id="loadingOverlay" style="position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:2.5rem;letter-spacing:0.08em;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">AresBrain</div>
      <div class="spinner" style="width:28px;height:28px;border-width:3px;"></div>
      <div style="font-size:0.8rem;color:var(--muted);">Cargando tu contenido...</div>
    </div>`);
  await loadState();
  document.getElementById('loadingOverlay').remove();
  showView('dashboard');
}
init();
</script>
</body>
</html>
